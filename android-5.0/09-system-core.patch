From 4552d1d2bce53e8320bc804fa5d51cbfa4a6265f Mon Sep 17 00:00:00 2001
From: codeworkx <codeworkx@cyanogenmod.org>
Date: Tue, 18 Nov 2014 12:30:33 -0500
Subject: [PATCH] libutils: refbase: jellybean mr1 compat

Also remerge: https://gerrit.omnirom.org/#/c/10054/

Change-Id: I9d810f37eb4e6a5929db4304bf3094c2374b5ac6
---
 include/utils/RefBase.h |  9 +++++++++
 libutils/RefBase.cpp    | 11 +++++++++++
 2 files changed, 20 insertions(+)

diff --git a/include/utils/RefBase.h b/include/utils/RefBase.h
index 8e15c19..a45a829 100644
--- a/include/utils/RefBase.h
+++ b/include/utils/RefBase.h
@@ -53,6 +53,15 @@ inline bool operator _op_ (const U* o) const {                  \
 
 // ---------------------------------------------------------------------------
 
+/* START JB MR1 COMPAT */
+class ReferenceConverterBase {
+public:
+    virtual size_t getReferenceTypeSize() const = 0;
+    virtual void* getReferenceBase(void const*) const = 0;
+    inline virtual ~ReferenceConverterBase() { }
+};
+/* END JB MR1 COMPAT */
+
 class ReferenceRenamer {
 protected:
     // destructor is purposedly not virtual so we avoid code overhead from
diff --git a/libutils/RefBase.cpp b/libutils/RefBase.cpp
index 02907ad..f8aefe3 100644
--- a/libutils/RefBase.cpp
+++ b/libutils/RefBase.cpp
@@ -630,6 +630,17 @@ void RefBase::onLastWeakRef(const void* /*id*/)
 
 // ---------------------------------------------------------------------------
 
+/* START JB MR1 COMPAT */
+extern "C" void _ZN7android7RefBase14moveReferencesEPvPKvjRKNS_22ReferenceConverterBaseE(void* dst, void const* src, size_t n,
+        const ReferenceConverterBase& caster)
+{
+    (void)(dst);
+    (void)(src);
+    (void)(n);
+    (void)(caster);
+}
+/* END JB MR1 COMPAT */
+
 #if DEBUG_REFS
 void RefBase::renameRefs(size_t n, const ReferenceRenamer& renamer) {
     for (size_t i=0 ; i<n ; i++) {

