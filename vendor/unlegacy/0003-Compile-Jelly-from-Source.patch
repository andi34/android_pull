From 50de70c510a9ccbe32a61d1fe2b725987fe02480 Mon Sep 17 00:00:00 2001
From: Andreas Blaesius <skate4life@gmx.de>
Date: Sat, 4 Nov 2017 15:14:18 +0100
Subject: [PATCH 3/5] Compile Jelly from Source

Change-Id: Iaeb485888dacf71737667fcaec0f9125f4674af2
---
 addonjelly/updater-script-install | 4 ++--
 build/tasks/addonjelly.mk         | 5 +++--
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/addonjelly/updater-script-install b/addonjelly/updater-script-install
index ce6468b..d039865 100644
--- a/addonjelly/updater-script-install
+++ b/addonjelly/updater-script-install
@@ -5,10 +5,10 @@ set_metadata("/tmp/mount-system.sh", "uid", 0, "gid", 0, "mode", 0755);
 run_program("/tmp/mount-system.sh") == 0 || abort("Could not mount /system");
 
 if getprop("ro.build.system_root_image") != "true" then
-  package_extract_dir("system", "/system");
+  package_extract_file("/system/app/Jelly/package.apk", "/system/app/Jelly/Jelly.apk");
   set_metadata("/system/app/Jelly/Jelly.apk", "uid", 0, "gid", 0, "mode", 0644, "selabel", "u:object_r:system_file:s0");
 else
-  package_extract_dir("system", "/system/system");
+  package_extract_file("/system/app/Jelly/package.apk", "/system/system/app/Jelly/Jelly.apk");
   set_metadata("/system/system/app/Jelly/Jelly.apk", "uid", 0, "gid", 0, "mode", 0644, "selabel", "u:object_r:system_file:s0");
 endif;
 
diff --git a/build/tasks/addonjelly.mk b/build/tasks/addonjelly.mk
index 9dbdcfe..c3c8772 100644
--- a/build/tasks/addonjelly.mk
+++ b/build/tasks/addonjelly.mk
@@ -3,12 +3,13 @@ ADDONJELLY_PREBUILTS_PATH := vendor/unlegacy/addonjelly
 ADDONJELLY_INSTALL_OUT := $(PRODUCT_OUT)/addonjelly-install
 ADDONJELLY_INSTALL_TARGET := $(PRODUCT_OUT)/Jelly.zip
 
-$(ADDONJELLY_INSTALL_TARGET): $(ALL_MODULES.updater.BUILT)
+$(ADDONJELLY_INSTALL_TARGET): $(ALL_MODULES.updater.BUILT) \
+		$(ALL_MODULES.Jelly.BUILT)
 	$(hide) rm -rf $@ $(ADDONJELLY_INSTALL_OUT)
 	$(hide) mkdir -p $(ADDONJELLY_INSTALL_OUT)/META-INF/com/google/android/
 	$(hide) mkdir -p $(ADDONJELLY_INSTALL_OUT)/system/app/Jelly/
 	$(hide) cp $(ALL_MODULES.updater.BUILT) $(ADDONJELLY_INSTALL_OUT)/META-INF/com/google/android/update-binary
-	$(hide) cp $(ADDONJELLY_PREBUILTS_PATH)/Jelly.apk $(ADDONJELLY_INSTALL_OUT)/system/app/Jelly/
+	$(hide) cp $(ALL_MODULES.Jelly.BUILT) $(ADDONJELLY_INSTALL_OUT)/system/app/Jelly/
 	$(hide) cp $(ADDONJELLY_PREBUILTS_PATH)/mount-system.sh $(ADDONJELLY_INSTALL_OUT)/
 	$(hide) cp $(ADDONJELLY_PREBUILTS_PATH)/updater-script-install $(ADDONJELLY_INSTALL_OUT)/META-INF/com/google/android/updater-script
 	$(hide) (cd $(ADDONJELLY_INSTALL_OUT) && zip -qr $@ *)
-- 
2.7.4

