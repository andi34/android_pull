From 4247c7eb01b9285770816824b84f547ff509ef31 Mon Sep 17 00:00:00 2001
From: Andreas Blaesius <andi@unlegacy-android.org>
Date: Wed, 10 Apr 2019 21:22:12 +0200
Subject: [PATCH] espresso: revert k3.4 compatibility for now

Change-Id: I0f7857d1e3e4d75cffec002f5fff33fc76e3d4b0
---
 rootdir/fstab.espresso   | 19 ++++++++-----------
 rootdir/init.espresso.rc |  3 ---
 sepolicy/file_contexts   | 14 +++++++-------
 3 files changed, 15 insertions(+), 21 deletions(-)

diff --git a/rootdir/fstab.espresso b/rootdir/fstab.espresso
index 727931d..4f19488 100644
--- a/rootdir/fstab.espresso
+++ b/rootdir/fstab.espresso
@@ -4,19 +4,16 @@
 # specify MF_CHECK, and must come before any filesystems that do specify MF_CHECK
 
 
-/dev/block/platform/omap_hsmmc.1/by-name/FACTORYFS /system             ext4      ro                                                    wait
-/dev/block/platform/omap_hsmmc.1/by-name/EFS       /efs                ext4      nosuid,nodev                                          wait,check
-/dev/block/platform/omap_hsmmc.1/by-name/CACHE     /cache              ext4      noatime,nosuid,nodev,nomblk_io_submit,errors=panic    wait,check
-/dev/block/platform/omap_hsmmc.1/by-name/CACHE     /cache              f2fs      noatime,nodiratime,nosuid,nodev,background_gc=off,inline_xattr,active_logs=2     wait
-/dev/block/platform/omap_hsmmc.1/by-name/DATAFS    /data               ext4      noatime,nosuid,nodev,nomblk_io_submit,errors=panic    wait,check,encryptable=footer
-/dev/block/platform/omap_hsmmc.1/by-name/DATAFS    /data               f2fs      noatime,nosuid,nodev,background_gc=off,inline_xattr,active_logs=2                wait,encryptable=footer
-/dev/block/platform/omap_hsmmc.1/by-name/KERNEL    /boot               emmc      defaults                                              defaults
-/dev/block/platform/omap_hsmmc.1/by-name/RECOVERY  /recovery           emmc      defaults                                              defaults
+/dev/block/platform/omap/omap_hsmmc.1/by-name/FACTORYFS /system             ext4      ro                                                    wait
+/dev/block/platform/omap/omap_hsmmc.1/by-name/EFS       /efs                ext4      nosuid,nodev                                          wait,check
+/dev/block/platform/omap/omap_hsmmc.1/by-name/CACHE     /cache              ext4      noatime,nosuid,nodev,nomblk_io_submit,errors=panic    wait,check
+/dev/block/platform/omap/omap_hsmmc.1/by-name/CACHE     /cache              f2fs      noatime,nodiratime,nosuid,nodev,background_gc=off,inline_xattr,active_logs=2     wait
+/dev/block/platform/omap/omap_hsmmc.1/by-name/DATAFS    /data               ext4      noatime,nosuid,nodev,nomblk_io_submit,errors=panic    wait,check,encryptable=footer
+/dev/block/platform/omap/omap_hsmmc.1/by-name/DATAFS    /data               f2fs      noatime,nosuid,nodev,background_gc=off,inline_xattr,active_logs=2                wait,encryptable=footer
+/dev/block/platform/omap/omap_hsmmc.1/by-name/KERNEL    /boot               emmc      defaults                                              defaults
+/dev/block/platform/omap/omap_hsmmc.1/by-name/RECOVERY  /recovery           emmc      defaults                                              defaults
 
 # vold-managed volumes
-/devices/platform/omap_hsmmc.0/mmc_host/mmc1*      auto                auto      defaults                                              wait,voldmanaged=sdcard1:auto,encryptable=userdata
-/devices/platform/musb-omap2430/musb-hdrc/usb1*    auto                auto      defaults                                              voldmanaged=usbdisk0:auto,noemulatedsd
-# k3.0
 /devices/platform/omap/omap_hsmmc.0/mmc_host/mmc1*      auto                auto      defaults                                              wait,voldmanaged=sdcard1:auto,encryptable=userdata
 /devices/platform/omap/musb-omap2430/musb-hdrc/usb1*    auto                auto      defaults                                              voldmanaged=usbdisk0:auto,noemulatedsd
 
diff --git a/rootdir/init.espresso.rc b/rootdir/init.espresso.rc
index a988004..c29ece3 100644
--- a/rootdir/init.espresso.rc
+++ b/rootdir/init.espresso.rc
@@ -9,9 +9,6 @@ on early-init
 on init
     symlink /sdcard /storage/sdcard0
 
-    # Make k3.0 compatible with k3.4+ fstab
-    symlink /dev/block/platform/omap/omap_hsmmc.1 /dev/block/platform/omap_hsmmc.1
-
     # KSM
     write /sys/kernel/mm/ksm/pages_to_scan 100
     write /sys/kernel/mm/ksm/sleep_millisecs 500
diff --git a/sepolicy/file_contexts b/sepolicy/file_contexts
index 0528846..4b1bbcf 100644
--- a/sepolicy/file_contexts
+++ b/sepolicy/file_contexts
@@ -29,13 +29,13 @@
 /system/vendor/firmware/ducati-m3.bin       u:object_r:firmware_ducati:s0
 
 # Block devices
-/dev/block/platform/omap_hsmmc.1/by-name/EFS       u:object_r:efs_block_device:s0
-/dev/block/platform/omap_hsmmc.1/by-name/MODEM     u:object_r:efs_block_device:s0
-/dev/block/platform/omap_hsmmc.1/by-name/KERNEL    u:object_r:boot_block_device:s0
-/dev/block/platform/omap_hsmmc.1/by-name/RECOVERY  u:object_r:recovery_block_device:s0
-/dev/block/platform/omap_hsmmc.1/by-name/FACTORYFS u:object_r:system_block_device:s0
-/dev/block/platform/omap_hsmmc.1/by-name/CACHE     u:object_r:cache_block_device:s0
-/dev/block/platform/omap_hsmmc.1/by-name/DATAFS    u:object_r:userdata_block_device:s0
+/dev/block/platform/omap/omap_hsmmc.1/by-name/EFS       u:object_r:efs_block_device:s0
+/dev/block/platform/omap/omap_hsmmc.1/by-name/MODEM     u:object_r:efs_block_device:s0
+/dev/block/platform/omap/omap_hsmmc.1/by-name/KERNEL    u:object_r:boot_block_device:s0
+/dev/block/platform/omap/omap_hsmmc.1/by-name/RECOVERY  u:object_r:recovery_block_device:s0
+/dev/block/platform/omap/omap_hsmmc.1/by-name/FACTORYFS u:object_r:system_block_device:s0
+/dev/block/platform/omap/omap_hsmmc.1/by-name/CACHE     u:object_r:cache_block_device:s0
+/dev/block/platform/omap/omap_hsmmc.1/by-name/DATAFS    u:object_r:userdata_block_device:s0
 
 # Swap
 /dev/block/zram(.*)                                     u:object_r:swap_block_device:s0
-- 
2.7.4

