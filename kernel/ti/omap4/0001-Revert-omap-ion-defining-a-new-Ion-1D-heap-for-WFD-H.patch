From 918ade4560f8a3ceaa34605517f24abf7e42a6b3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?D=2E=20Andrei=20M=C4=83ce=C8=99?= <dmaces@nd.edu>
Date: Tue, 24 Nov 2015 13:01:28 -0500
Subject: [PATCH 001/111] Revert "omap: ion: defining a new Ion 1D heap for WFD
 HDCP"
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This reverts commit 7984970f056683cef64d8f5279ae0fea4e53efb5.

Change-Id: I37341f92763a3e8c98febbbc48517aa378123ac5
Signed-off-by: D. Andrei Măceș <dmaces@nd.edu>
---
 arch/arm/mach-omap2/board-4430sdp.c          |  3 +-
 arch/arm/mach-omap2/board-44xx-tablet.c      |  3 +-
 arch/arm/mach-omap2/board-omap4panda.c       |  3 +-
 arch/arm/mach-omap2/include/mach/omap4_ion.h |  9 ------
 arch/arm/mach-omap2/omap4_ion.c              | 47 +++-------------------------
 include/linux/omap_ion.h                     |  1 -
 6 files changed, 7 insertions(+), 59 deletions(-)

diff --git a/arch/arm/mach-omap2/board-4430sdp.c b/arch/arm/mach-omap2/board-4430sdp.c
index d0ffd65..671dbb6 100644
--- a/arch/arm/mach-omap2/board-4430sdp.c
+++ b/arch/arm/mach-omap2/board-4430sdp.c
@@ -1259,8 +1259,7 @@ static void __init omap_4430sdp_reserve(void)
 	/* ipu needs to recognize secure input buffer area as well */
 	omap_ipu_set_static_mempool(PHYS_ADDR_DUCATI_MEM,
 					PHYS_ADDR_DUCATI_SIZE +
-					OMAP4_ION_HEAP_SECURE_INPUT_SIZE +
-					OMAP4_ION_HEAP_SECURE_OUTPUT_WFDHDCP_SIZE);
+					OMAP4_ION_HEAP_SECURE_INPUT_SIZE);
 
 	omap_reserve();
 }
diff --git a/arch/arm/mach-omap2/board-44xx-tablet.c b/arch/arm/mach-omap2/board-44xx-tablet.c
index e65943e..be9b26e 100644
--- a/arch/arm/mach-omap2/board-44xx-tablet.c
+++ b/arch/arm/mach-omap2/board-44xx-tablet.c
@@ -759,8 +759,7 @@ static void __init omap_tablet_reserve(void)
 	memblock_remove(PHYS_ADDR_DUCATI_MEM, PHYS_ADDR_DUCATI_SIZE);
 	/* ipu needs to recognize secure input buffer area as well */
 	omap_ipu_set_static_mempool(PHYS_ADDR_DUCATI_MEM, PHYS_ADDR_DUCATI_SIZE +
-					OMAP4_ION_HEAP_SECURE_INPUT_SIZE +
-					OMAP4_ION_HEAP_SECURE_OUTPUT_WFDHDCP_SIZE);
+					OMAP4_ION_HEAP_SECURE_INPUT_SIZE);
 	omap_reserve();
 }
 
diff --git a/arch/arm/mach-omap2/board-omap4panda.c b/arch/arm/mach-omap2/board-omap4panda.c
index 9b78cc5..9311988 100644
--- a/arch/arm/mach-omap2/board-omap4panda.c
+++ b/arch/arm/mach-omap2/board-omap4panda.c
@@ -829,8 +829,7 @@ static void __init omap4_panda_reserve(void)
 	memblock_remove(PHYS_ADDR_DUCATI_MEM, PHYS_ADDR_DUCATI_SIZE);
 	/* ipu needs to recognize secure input buffer area as well */
 	omap_ipu_set_static_mempool(PHYS_ADDR_DUCATI_MEM, PHYS_ADDR_DUCATI_SIZE +
-					OMAP4_ION_HEAP_SECURE_INPUT_SIZE +
-					OMAP4_ION_HEAP_SECURE_OUTPUT_WFDHDCP_SIZE);
+					OMAP4_ION_HEAP_SECURE_INPUT_SIZE);
 
 	omap_reserve();
 }
diff --git a/arch/arm/mach-omap2/include/mach/omap4_ion.h b/arch/arm/mach-omap2/include/mach/omap4_ion.h
index 3403662..bac1281 100644
--- a/arch/arm/mach-omap2/include/mach/omap4_ion.h
+++ b/arch/arm/mach-omap2/include/mach/omap4_ion.h
@@ -22,8 +22,6 @@
 #define OMAP4_RAM_SIZE (omap_total_ram_size())
 #define PHYS_ADDR_SMC_MEM  (omap_smc_addr())
 #define PHYS_ADDR_ION_HEAP_SECURE_INPUT_MEM  (omap_ion_heap_secure_input_addr())
-#define PHYS_ADDR_ION_HEAP_SECURE_OUTPUT_WFDHDCP_MEM  \
-			(omap_ion_heap_secure_output_wfdhdcp_addr())
 #define PHYS_ADDR_DUCATI_MEM	(omap_ducati_heap_addr())
 #define PHYS_ADDR_ION_HEAP_TILER_MEM	(omap_ion_heap_tiler_mem_addr())
 #define PHYS_ADDR_ION_HEAP_NONSECURE_TILER_MEM	\
@@ -31,8 +29,6 @@
 
 #define PHYS_ADDR_SMC_SIZE (omap_smc_size())
 #define OMAP4_ION_HEAP_SECURE_INPUT_SIZE (omap_ion_heap_secure_input_size())
-#define OMAP4_ION_HEAP_SECURE_OUTPUT_WFDHDCP_SIZE \
-			(omap_ion_heap_secure_output_wfdhdcp_size())
 #define PHYS_ADDR_DUCATI_SIZE (omap_ducati_heap_size())
 #define OMAP4_ION_HEAP_TILER_SIZE (omap_ion_heap_tiler_mem_size())
 #define OMAP4_ION_HEAP_NONSECURE_TILER_SIZE	\
@@ -45,7 +41,6 @@ struct omap_ion_platform_data {
 	u32 tiler2d_size;
 	u32 nonsecure_tiler2d_size;
 	size_t ducati_heap_size;
-	size_t secure_output_wfdhdcp_size;
 };
 
 struct omap_ion_platform_data *get_omap_ion_platform_data(void);
@@ -63,12 +58,10 @@ void omap_ion_init(void);
 void omap4_register_ion(void);
 
 phys_addr_t omap_ion_heap_secure_input_addr(void);
-phys_addr_t omap_ion_heap_secure_output_wfdhdcp_addr(void);
 phys_addr_t omap_ion_heap_tiler_mem_addr(void);
 phys_addr_t omap_ion_heap_nonsec_tiler_mem_addr(void);
 
 size_t omap_ion_heap_secure_input_size(void);
-size_t omap_ion_heap_secure_output_wfdhdcp_size(void);
 size_t omap_ion_heap_tiler_mem_size(void);
 size_t omap_ion_heap_nonsec_tiler_mem_size(void);
 
@@ -77,12 +70,10 @@ static inline void omap_ion_init(void) { return; }
 static inline void omap4_register_ion(void) { return; }
 
 phys_addr_t omap_ion_heap_secure_input_addr(void) { return 0; }
-phys_addr_t omap_ion_heap_secure_output_wfdhdcp_addr(void) { return 0; }
 phys_addr_t omap_ion_heap_tiler_mem_addr(void) { return 0; }
 phys_addr_t omap_ion_heap_nonsec_tiler_mem_addr(void) { return 0; }
 
 size_t omap_ion_heap_secure_input_size(void) { return 0; }
-size_t omap_ion_heap_secure_output_wfdhdcp_size(void) { return 0; }
 size_t omap_ion_heap_tiler_mem_size(void) { return 0; }
 size_t omap_ion_heap_nonsec_tiler_mem_size(void) { return 0; }
 #endif
diff --git a/arch/arm/mach-omap2/omap4_ion.c b/arch/arm/mach-omap2/omap4_ion.c
index 612d0db..9ae6d74 100644
--- a/arch/arm/mach-omap2/omap4_ion.c
+++ b/arch/arm/mach-omap2/omap4_ion.c
@@ -38,14 +38,12 @@ static bool system_512m;
 
 static phys_addr_t omap4_smc_addr;
 static phys_addr_t omap4_ion_heap_secure_input_addr;
-static phys_addr_t omap4_ion_heap_secure_output_wfdhdcp_addr;
 static phys_addr_t omap4_ducati_heap_addr;
 static phys_addr_t omap4_ion_heap_tiler_mem_addr;
 static phys_addr_t omap4_ion_heap_nonsec_tiler_mem_addr;
 
 static size_t omap4_smc_size;
 static size_t omap4_ion_heap_secure_input_size;
-static size_t omap4_ion_heap_secure_output_wfdhdcp_size;
 static size_t omap4_ducati_heap_size;
 static size_t omap4_ion_heap_tiler_mem_size;
 static size_t omap4_ion_heap_nonsec_tiler_mem_size;
@@ -65,18 +63,13 @@ static struct page* omap4_ion_rpmsg_cma_pages;
 #endif
 
 static struct ion_platform_data omap4_ion_data = {
-	.nr = 6,
+	.nr = 5,
 	.heaps = {
 		{
 			.type = ION_HEAP_TYPE_CARVEOUT,
 			.id = OMAP_ION_HEAP_SECURE_INPUT,
 			.name = "secure_input",
 		},
-		{
-			.type = ION_HEAP_TYPE_CARVEOUT,
-			.id = OMAP_ION_HEAP_SECURE_OUTPUT_WFDHDCP,
-			.name = "secure_output_wfdhdcp",
-		},
 		{	.type = OMAP_ION_HEAP_TYPE_TILER,
 			.id = OMAP_ION_HEAP_TILER,
 			.name = "tiler",
@@ -139,13 +132,10 @@ void __init omap_ion_init(void)
 
 	if (system_512m) {
 		omap4_ion_heap_secure_input_size = 0;
-		omap4_ion_heap_secure_output_wfdhdcp_size = 0;
 		omap4_ducati_heap_size = (SZ_1M * 83);
 		omap4_ion_heap_nonsec_tiler_mem_size = 0;
 		omap4_ion_heap_tiler_mem_size = 0;
 	} else {
-		omap4_ion_heap_secure_output_wfdhdcp_size =
-				omap4_ion_pdata.secure_output_wfdhdcp_size;
 		omap4_ducati_heap_size = omap4_ion_pdata.ducati_heap_size;
 #ifdef CONFIG_ION_OMAP_TILER_DYNAMIC_ALLOC
 		omap4_ion_heap_secure_input_size = 0;
@@ -168,13 +158,10 @@ void __init omap_ion_init(void)
 	omap4_ion_heap_secure_input_addr = omap4_smc_addr -
 				omap4_ion_heap_secure_input_size;
 #endif
-	omap4_ion_heap_secure_output_wfdhdcp_addr =
-				omap4_ion_heap_secure_input_addr -
-				omap4_ion_heap_secure_output_wfdhdcp_size;
 #ifdef CONFIG_MACH_OMAP4_ESPRESSO
 	omap4_ducati_heap_addr = ESPRESSO_DUCATI_HEAP_ADDR;
 #else
-	omap4_ducati_heap_addr = omap4_ion_heap_secure_output_wfdhdcp_addr -
+	omap4_ducati_heap_addr = omap4_ion_heap_secure_input_addr -
 				omap4_ducati_heap_size;
 #endif
 	omap4_ion_heap_tiler_mem_addr = omap4_ducati_heap_addr -
@@ -185,34 +172,29 @@ void __init omap_ion_init(void)
 	pr_info("omap4_total_ram_size = 0x%x\n" \
 				"omap4_smc_size = 0x%x\n"  \
 				"omap4_ion_heap_secure_input_size = 0x%x\n"  \
-				"omap4_ion_heap_secure_output_wfdhdcp_size = 0x%x\n"  \
 				"omap4_ducati_heap_size = 0x%x\n"  \
 				"omap4_ion_heap_tiler_mem_size = 0x%x\n"  \
 				"omap4_ion_heap_nonsec_tiler_mem_size  = 0x%x\n",
 				omap_total_ram_size(),
 				omap4_smc_size,
 				omap4_ion_heap_secure_input_size,
-				omap4_ion_heap_secure_output_wfdhdcp_size,
 				omap4_ducati_heap_size,
 				omap4_ion_heap_tiler_mem_size,
 				omap4_ion_heap_nonsec_tiler_mem_size);
 
 	pr_info(" omap4_smc_addr = 0x%x\n"  \
 				"omap4_ion_heap_secure_input_addr = 0x%x\n"  \
-				"omap4_ion_heap_secure_output_wfdhdcp_addr = 0x%x\n"  \
 				"omap4_ducati_heap_addr = 0x%x\n"  \
 				"omap4_ion_heap_tiler_mem_addr = 0x%x\n"  \
 				"omap4_ion_heap_nonsec_tiler_mem_addr  = 0x%x\n",
 				omap4_smc_addr,
 				omap4_ion_heap_secure_input_addr,
-				omap4_ion_heap_secure_output_wfdhdcp_addr,
 				omap4_ducati_heap_addr,
 				omap4_ion_heap_tiler_mem_addr,
 				omap4_ion_heap_nonsec_tiler_mem_addr);
 
 #ifdef CONFIG_CMA
 	ipu_cma_pages_count = (omap4_ion_heap_secure_input_size +
-				omap4_ion_heap_secure_output_wfdhdcp_size +
 				omap4_ducati_heap_size +
 				omap4_ion_heap_nonsec_tiler_mem_size +
 				omap4_ion_heap_tiler_mem_size) / PAGE_SIZE;
@@ -249,10 +231,6 @@ void __init omap_ion_init(void)
 			h->base = omap4_ion_heap_secure_input_addr;
 			h->size = omap4_ion_heap_secure_input_size;
 			break;
-		case OMAP_ION_HEAP_SECURE_OUTPUT_WFDHDCP:
-			h->base = omap4_ion_heap_secure_output_wfdhdcp_addr;
-			h->size = omap4_ion_heap_secure_output_wfdhdcp_size;
-			break;
 		case OMAP_ION_HEAP_NONSECURE_TILER:
 			h->base = omap4_ion_heap_nonsec_tiler_mem_addr;
 			h->size = omap4_ion_heap_nonsec_tiler_mem_size;
@@ -272,19 +250,12 @@ void __init omap_ion_init(void)
 	for (i = 0; i < omap4_ion_data.nr; i++)
 		if (omap4_ion_data.heaps[i].type == ION_HEAP_TYPE_CARVEOUT ||
 		    omap4_ion_data.heaps[i].type == OMAP_ION_HEAP_TYPE_TILER) {
-			if (!omap4_ion_data.heaps[i].size)
-				continue;
 #ifndef CONFIG_CMA
 			ret = memblock_remove(omap4_ion_data.heaps[i].base,
 					      omap4_ion_data.heaps[i].size);
 #endif
-			if (omap4_ion_data.heaps[i].id ==
-					OMAP_ION_HEAP_SECURE_OUTPUT_WFDHDCP) {
-				/* Reducing the actual size being mapped for Ion/Ducati as
-				 * secure component uses the remaining memory */
-				omap4_ion_data.heaps[i].size =
-					omap4_ion_heap_secure_output_wfdhdcp_size >> 1;
-			}
+			if (!omap4_ion_data.heaps[i].size)
+				continue;
 			if (ret)
 				pr_err("memblock remove of %x@%lx failed\n",
 				       omap4_ion_data.heaps[i].size,
@@ -302,11 +273,6 @@ phys_addr_t omap_ion_heap_secure_input_addr(void)
 	return omap4_ion_heap_secure_input_addr;
 }
 
-phys_addr_t omap_ion_heap_secure_output_wfdhdcp_addr(void)
-{
-	return omap4_ion_heap_secure_output_wfdhdcp_addr;
-}
-
 phys_addr_t omap_ducati_heap_addr(void)
 {
 	return omap4_ducati_heap_addr;
@@ -332,11 +298,6 @@ size_t omap_ion_heap_secure_input_size(void)
 	return omap4_ion_heap_secure_input_size;
 }
 
-size_t omap_ion_heap_secure_output_wfdhdcp_size(void)
-{
-	return omap4_ion_heap_secure_output_wfdhdcp_size;
-}
-
 size_t omap_ducati_heap_size(void)
 {
 	return omap4_ducati_heap_size;
diff --git a/include/linux/omap_ion.h b/include/linux/omap_ion.h
index e88d02a..a13a6e7 100644
--- a/include/linux/omap_ion.h
+++ b/include/linux/omap_ion.h
@@ -98,7 +98,6 @@ enum {
 	OMAP_ION_HEAP_SECURE_INPUT,
 	OMAP_ION_HEAP_NONSECURE_TILER,
 	OMAP_ION_HEAP_TILER_RESERVATION,
-	OMAP_ION_HEAP_SECURE_OUTPUT_WFDHDCP,
 };
 
 #endif /* _LINUX_ION_H */
-- 
2.7.4

